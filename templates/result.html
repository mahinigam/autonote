{% extends "base.html" %}
{% block content %}
<div class="max-w-7xl mx-auto flex gap-6">
  <!-- Main Content -->
  <div class="flex-1 max-w-4xl">
    <div class="text-center mb-8">
      <img src="{{ url_for('static', filename='images/autonote-logo.png') }}" 
           alt="autonote" 
           class="autonote-logo-small mx-auto mb-2"
           onerror="this.style.display='none'; document.getElementById('result-fallback-title').style.display='block';">
      <h1 id="result-fallback-title" class="text-3xl font-bold text-primary" style="display: none;">Generated Notes</h1>
      <h2 class="text-xl text-secondary">Generated Notes</h2>
    </div>
    
    {% if notes %}
      <div class="glass-card rounded-lg p-8 mb-8">
        <h2 class="text-xl font-semibold mb-4 text-primary">Your Structured Notes</h2>
        <div class="markdown-content">
          {{ notes_html|safe }}
        </div>
      </div>
      
      <div class="glass rounded-lg p-6 mb-8">
        <h3 class="text-lg font-semibold mb-4 text-primary">Download Options</h3>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
          <a href="/download/{{ file_id }}?format=txt" 
             class="flex items-center justify-center py-3 px-4 glass-button text-white rounded-lg text-sm font-medium">
            Download .txt
          </a>
          <a href="/download/{{ file_id }}?format=pdf" 
             class="flex items-center justify-center py-3 px-4 glass-button text-white rounded-lg text-sm font-medium">
            Download .pdf
          </a>
          <a href="/download/{{ file_id }}?format=docx" 
             class="flex items-center justify-center py-3 px-4 glass-button text-white rounded-lg text-sm font-medium">
            Download .docx
          </a>
        </div>
      </div>
    {% endif %}
    
    {% if original_text %}
      <details class="glass-card rounded-lg p-6 mb-8">
        <summary class="cursor-pointer text-lg font-semibold text-primary hover:text-white select-none">
          Show Original Extracted Text
        </summary>
        <div class="mt-4 p-4 glass rounded-lg border-l-4 border-white/60">
          <pre class="whitespace-pre-wrap text-sm leading-relaxed" style="color: #ffffff; font-weight: 500;">{{ original_text }}</pre>
        </div>
      </details>
    {% endif %}
    
    <div class="text-center">
      <a href="/" 
         class="inline-flex items-center px-6 py-3 red-button text-white rounded-lg font-medium">
        ← Process Another Document
      </a>
    </div>
  </div>

  <!-- Chatbot Sidebar -->
  <div class="w-96 glass-card rounded-lg p-6 h-fit sticky top-8">
    <div class="flex items-center mb-4">
      <div class="w-3 h-3 bg-green-400 rounded-full mr-3 animate-pulse"></div>
      <h3 class="text-lg font-semibold text-primary">AI Assistant</h3>
    </div>
    
    <p class="text-secondary text-sm mb-4">
      Ask me anything about your document! I can create tables, summaries, lists, or answer specific questions.
    </p>
    
    <!-- Chat Messages -->
    <div id="chatMessages" class="h-64 overflow-y-auto mb-4 p-3 glass rounded-lg">
      <div class="text-center text-muted text-sm">
        Start a conversation by asking a question about your document!
      </div>
    </div>
    
    <!-- Quick Suggestions -->
    <div class="mb-4">
      <div class="text-sm font-medium text-secondary mb-2">Quick Suggestions:</div>
      <div class="space-y-2">
        {% for suggestion in chat_suggestions %}
          <button onclick="askQuestion('{{ suggestion|e }}')" 
                  class="w-full text-left p-2 text-xs glass rounded hover:bg-white/10 text-secondary hover:text-white transition-all">
            {{ suggestion }}
          </button>
        {% endfor %}
      </div>
    </div>
    
    <!-- Chat Input -->
    <div class="flex gap-2">
      <input type="text" 
             id="chatInput" 
             placeholder="Ask about the document..."
             class="flex-1 p-3 glass-input rounded-lg text-sm"
             onkeypress="handleChatKeyPress(event)">
      <button onclick="sendMessage()" 
              class="px-4 py-3 electric-green-button rounded-lg text-sm font-semibold">
        Send
      </button>
    </div>
    
    <div class="mt-3 text-xs text-muted text-center">
      Powered by AI • Responses based on your document
    </div>
  </div>
</div>

<script>
let isLoading = false;

function handleChatKeyPress(event) {
  if (event.key === 'Enter' && !event.shiftKey) {
    event.preventDefault();
    sendMessage();
  }
}

function askQuestion(question) {
  document.getElementById('chatInput').value = question;
  sendMessage();
}

function addMessage(message, isUser = false) {
  const messagesDiv = document.getElementById('chatMessages');
  const messageDiv = document.createElement('div');
  messageDiv.className = `mb-3 ${isUser ? 'text-right' : 'text-left'}`;
  
  const messageContent = document.createElement('div');
  messageContent.className = `inline-block p-3 rounded-lg max-w-xs ${
    isUser 
      ? 'bg-white/20 text-white' 
      : 'glass text-secondary'
  }`;
  
  if (isUser) {
    messageContent.textContent = message;
  } else {
    // Render markdown in bot responses
    messageContent.innerHTML = message.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                                     .replace(/\*(.*?)\*/g, '<em>$1</em>')
                                     .replace(/\n/g, '<br>');
  }
  
  messageDiv.appendChild(messageContent);
  messagesDiv.appendChild(messageDiv);
  messagesDiv.scrollTop = messagesDiv.scrollHeight;
  
  // Clear welcome message on first interaction
  if (messagesDiv.children.length === 2) {
    messagesDiv.removeChild(messagesDiv.firstChild);
  }
}

function showTypingIndicator() {
  const messagesDiv = document.getElementById('chatMessages');
  const typingDiv = document.createElement('div');
  typingDiv.id = 'typingIndicator';
  typingDiv.className = 'mb-3 text-left';
  typingDiv.innerHTML = `
    <div class="inline-block p-3 rounded-lg glass text-secondary">
      <div class="flex space-x-1">
        <div class="w-2 h-2 bg-white/60 rounded-full animate-bounce"></div>
        <div class="w-2 h-2 bg-white/60 rounded-full animate-bounce" style="animation-delay: 0.1s"></div>
        <div class="w-2 h-2 bg-white/60 rounded-full animate-bounce" style="animation-delay: 0.2s"></div>
      </div>
    </div>
  `;
  messagesDiv.appendChild(typingDiv);
  messagesDiv.scrollTop = messagesDiv.scrollHeight;
}

function removeTypingIndicator() {
  const typingIndicator = document.getElementById('typingIndicator');
  if (typingIndicator) {
    typingIndicator.remove();
  }
}

async function sendMessage() {
  if (isLoading) return;
  
  const input = document.getElementById('chatInput');
  const question = input.value.trim();
  
  if (!question) return;
  
  // Add user message
  addMessage(question, true);
  input.value = '';
  
  // Show typing indicator
  showTypingIndicator();
  isLoading = true;
  
  try {
    const response = await fetch('/api/chat', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({ question: question })
    });
    
    const data = await response.json();
    
    removeTypingIndicator();
    
    if (data.success) {
      addMessage(data.response, false);
    } else {
      addMessage('Sorry, I encountered an error. Please try again.', false);
    }
  } catch (error) {
    removeTypingIndicator();
    addMessage('Sorry, I couldn\'t process your request. Please try again.', false);
  } finally {
    isLoading = false;
  }
}
</script>
{% endblock %}
